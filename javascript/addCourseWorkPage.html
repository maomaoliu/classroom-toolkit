<script>
    function initCourseWorkPage() {
        $('#classroom-name').text(currentClassroom.name);
        $('#classroom-url').text(currentClassroom.alternateLink);

        google.script.run
            .withSuccessHandler(listCourseWorkHandler)
            .listCourseWork(currentClassroom.id);
        google.script.run
            .withSuccessHandler(listTopicsNotReleasedHandler)
            .listTopicsNotReleased(currentClassroom.id);

    }

    function releaseTopicMaterials() {
        let topicName = $('input[name=topic]:checked').val();
        let practiceDueTime = $('#practice-due-time').val();
        let assignmentDueTime = $('#assignment-due-time').val();
        google.script.run
            .withSuccessHandler(createCourseWorksHandler)
            .createCourseWorks(currentClassroom.id, topicName, practiceDueTime, assignmentDueTime) ;        
    }

    function goBackToMainPage() {
        updateStatus({ listingDiv: true, creatingDiv: false, operatingDiv: false });
    }

    function createCourseWorksHandler(response) {
        initCourseWorkPage();
    }

    function listCourseWorkHandler(response) {
        let courseWorksElememt = $('#released-classworks');
        courseWorksElememt.html('');
        response.filter(courseWorkGroupedByTopic => courseWorkGroupedByTopic.courseWorks.length > 0)
            .forEach(courseWorkGroupedByTopic => {
                const topicName = $(document.createElement('span')).prop({ class: 'topic-name' });
                topicName.text(courseWorkGroupedByTopic.topic.name);
                const ul = $(document.createElement('ul')).prop({ class: 'classworks-under-topic' });
                courseWorkGroupedByTopic.courseWorks.forEach(courseWork => {
                    const li = $(document.createElement('li')).prop({ class: 'classworks' });
                    const courseWorkTitle = $(document.createElement('span')).prop({ class: 'title' });
                    const courseWorkState = $(document.createElement('span')).prop({ class: 'state' });
                    courseWorkTitle.text(courseWork.title);
                    courseWorkState.text(courseWork.state);
                    li.append(courseWorkTitle).append(courseWorkState);
                    ul.append(li);
                })

                const topic = $(document.createElement('div')).prop({ class: 'topic' });
                topic.append(topicName).append(ul);
                courseWorksElememt.append(topic);
            })
    }

    function listTopicsNotReleasedHandler(response) {
        let topicsToAddElement = $('#to-release-topics');
        topicsToAddElement.html('');
        response.forEach((topic, index) => {
            const input = $(document.createElement('input')).prop({
                type: 'radio',
                name: 'topic',
                value: topic.name,
                id: index,
            });
            const topicLabel = $(document.createElement('label')).prop({
                for: index,
                class: 'topic-name'
            }).text(topic.name);
            const topicDetailSpan = $(document.createElement('span')).prop({ class: 'topic-detail'}).text('共 ' + topic.materialCount + ' 个课程材料' );
            const li = $(document.createElement('li')).prop({ class: 'topic' });
            li.append(input).append(topicLabel).append(topicDetailSpan);
            topicsToAddElement.append(li);
        });
    }
</script>